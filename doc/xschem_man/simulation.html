<!DOCTYPE html>
<html>
<head>
<title>SIMULATION</title>
<link rel="stylesheet" type="text/css" href="xschem_man.css" />
<style type="text/css">
/* Local styling goes here */
p{padding: 15px  30px 10px;}

</style>

</head>
<body>

<!-- start of slide -->
<div class="content">   
<!-- navigation buttons -->
<a href="net_probes.html" class="prev">PREV</a>
<a href="xschem_man.html" class="home">UP</a>
<a href="simulation.html" class="next">NEXT</a>
 <!-- slide title -->
 <h1>SIMULATION</h1><br>
 <h3> VERILOG SIMULATION</h3>
 <p> This is a tutorial showing how to run a simulation with XSCHEM. The first important thing to
  note is that XSCHEM is just a schematic editor, so we need to setup valid bindings to
  simulators in the <tt>~/.xschem</tt> file. For this tutorial we plan to do a <tt>Verilog</tt>
  simulation since there is a very good open source simulator available, called
  <a href="http://iverilog.icarus.com">Icarus Verilog</a>.
  There is also a good waveform viewer called 
  <a href="https://sourceforge.net/projects/gtkwave">gtkwave</a>
  that is able to show simulator results. Install these two valuable tools and setup
  installation paths in <tt>.xschem</tt>: 
 </p>
 <pre class="code">
...
## icarus verilog
set iverilog_path $env(HOME)/verilog/bin/iverilog
set vvp_path $env(HOME)/verilog/bin/vvp
set iverilog_opts {-g2012}
...
## gtkwave
set gtkwave_path $env(HOME)/gtkwave/bin/gtkwave
...
 </pre>
 <p>
  In the XSCHEM distribution there is one example design, <tt>examples/greycnt.sch</tt>.<br>
  Load this design: 
 </p>
 <pre class="code">
user:~$ xschem examples/greycnt
 </pre>
 <img src="simulation1.png">
 <p>
  This testbench has a 8 bit input vector A[7:0] and two output vectors, B[7:0] and C[7:0]
  the B[7:0] is a grey coded vector, this mean that if A[] is incremented as a binary number
  B will increment by changing only one bit at a time. The C[7:0] vector is the reverse transformation
  from grey-code to binary, so at the end if simulation goes well C[7:0] == A[7:0].
  In this schematic there are some components, the first one is the <tt>xnor</tt> gate, the second one is
  the <tt>assign</tt> element. The 'xnor' performs the logical 'Not-Xor' of its inputs, while 'assign'
  just propagates the input unchanged to the output, optionally with some delay.
  This is useful if we want to change the name of a net
  (putting two labels with different names on the same net is not allowed, since this is normally an error, 
  leading to a short circuit).
 </p>
 <p>
  An Ex-Nor gate can be represented as a verilog primitive, so for the xnor gate we just need to setup 
  a <tt>verilog_format</tt> attribute in the global property string of the <tt>xnor.sym</tt> gate: 
 </p>
 <img src="simulation2.png">
 <p>
  the 'assign' symbol is much simpler, in this property string you see the definition for SPICE
  (<tt>format</tt> attribute), Verilog (<tt>verilog_format</tt>) and VHDL (<tt>vhdl_format</tt>).
   This shows how a single symbol can be used for different netlist formats.
 </p>
 <img src="simulation3.png">
 <p>
  While showing the top-level testbench <tt>greycnt</tt> set XSCHEM in Verilog mode
  (menu <tt>Options-&gt;Verilog</tt> radio button, or <tt>&lt;Shift&gt;V</tt> key) and press
  the edit property <tt>'q'</tt> key, you will see some verilog code:
 </p>
 <img src="simulation4.png">
 <p> 
  This is the testbench behavioral code that generates stimuli for the simulation and gives
  instructions on where to save simulation results. If you generate the verilog netlist with 
  the <tt>Netlist</tt> button on the right side of the menu bar (or <tt>&lt;Shift&gt;N</tt>
  key) a <tt>greycnt.v</tt> file will be generated in the simulation directory
  (<tt>${HOME}/xschem_library/simulations</tt> is the default path in the XSCHEM distribution, but
  can be changed with the <tt>set netlist_dir $env(HOME)/simulations</tt> in ~/.xschem file):
 </p>
 <pre class="code">
`timescale 1ps/1ps
module greycnt (
  output wire [7:0] B,
  output wire [7:0] C
);

reg [7:0] A  ;

xnor #(1 , 1 ) x2 ( B[4] , A[5] , A[4] ); 
xnor #(1 , 1 ) x3 ( B[5] , A[6] , A[5] ); 
xnor #(1 , 1 ) x14 ( B[6] , A[7] , A[6] ); 
assign #1 B[7] = A[7] ; 
xnor #(1 , 1 ) x1 ( B[1] , A[2] , A[1] ); 
xnor #(1 , 1 ) x4 ( B[2] , A[3] , A[2] ); 
xnor #(1 , 1 ) x5 ( B[3] , A[4] , A[3] ); 
xnor #(1 , 1 ) x6 ( B[0] , A[1] , A[0] ); 
xnor #(1 , 1 ) x7 ( C[4] , C[5] , B[4] ); 
xnor #(1 , 1 ) x8 ( C[5] , C[6] , B[5] ); 
xnor #(1 , 1 ) x9 ( C[6] , C[7] , B[6] ); 
assign #1 C[7] = B[7] ; 
xnor #(1 , 1 ) x10 ( C[1] , C[2] , B[1] ); 
xnor #(1 , 1 ) x11 ( C[2] , C[3] , B[2] ); 
xnor #(1 , 1 ) x12 ( C[3] , C[4] , B[3] ); 
xnor #(1 , 1 ) x13 ( C[0] , C[1] , B[0] ); 
initial begin
  $dumpfile("dumpfile.vcd");
  $dumpvars;
  A=0;
end

always begin
  #1000;
  $display("%08b %08b", A, B);
  A=A + 1;
  if(A==0) $finish;
end
endmodule
 </pre>
 <p>
  you will recognize the behavioral code right after the netlist specifying the connection of
  nets to the xnor and assign gates and all the necessary verilog declarations.
  If you press the <tt>Simulation</tt> button the <tt>Icarus Verilog</tt> simulator will be executed
  to compile (iverilog) and run (vvp) the simulation, a terminal window will show the simulation output,
  in this case the input vector A[7:0] and the grey coded B[7:0] vectors are shown. You can quit the
  simulator log window by pressing <tt>'q'</tt>.
 </p>
 <img src="simulation5.png">
 <p>
  If simulation completes with no errors waveforms can be viewed. Press the <tt>Waves</tt> button
  in the top-right of the menu bar, you may add waveforms in the gtkwave window:
 </p>
 <img src="simulation6.png">
 <p>
  If the schematic contains errors that the simulator can not handle instead of the simulation
  log a window showing the error messages from the simulator is shown: 
 </p>
 <img src="simulation7.png">
 <p>
  To facilitate the debug you may wish to edit the netlist (<tt>Simulation-&gt;Edit Netlist</tt>)
  to locate the error, in the picture below i inserted deliberately a random string to
  trigger the failure:
 </p>
 <img src="simulation8.png">
 <p>
  As you can see the error is in the behavioral code of the top level greycnt schematic, so edit the 
  global property (<tt>'q'</tt> key with no component selected) and fix the error.
 </p>
 <img src="simulation9.png">

 <!-- end of slide -->
 <div class="filler"></div>
</div>

<!-- frame footer -->
<iframe seamless src="xschem_footer.html"  class="footer_iframe" >
</body>
</html>

