#!/usr/bin/awk -f
# 

/^[ \t]*;/{ next }
{ sub(/;/," ;",$0) }

$3 ~/^%/{
  a=$0
  sub(/^[^%]*%/,"",a)
  sub(/%[^%]*$/,"",a)
  gsub(/ /,"_", a)
  sub(/%[^%]*%/, "%" a "%")
}


{ print }


